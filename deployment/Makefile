# Makefile pour DÃ©ploiement Teams GPT Assistant
# Encapsule les workflows Microsoft 365 Agents Toolkit

.PHONY: help clean provision-local provision-playground provision-dev deploy-local deploy-playground deploy-dev start-local start-playground validate-manifest check-package

# Couleurs pour les messages
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

##@ Aide

.PHONY: partner-center-info
partner-center-info: ## Afficher les informations pour Partner Center
	@echo ""
	@echo "ðŸ¢ Informations Partner Center - Teams GPT"
	@echo "=========================================="
	@echo ""
	@echo "ðŸ“¦ Package Ã  uploader :"
	@if [ -f "../appPackage/build/appPackage.dev.zip" ]; then \
		echo "   âœ“ appPackage.dev.zip ($(shell ls -lh ../appPackage/build/appPackage.dev.zip | awk '{print $$5}'))"; \
		echo "   ðŸ“ Chemin : $(shell pwd)/../appPackage/build/appPackage.dev.zip"; \
	else \
		echo "   âœ— Package manquant - ExÃ©cuter 'make provision-dev' d'abord"; \
	fi
	@echo ""
	@echo "ðŸ†” Identifiants Teams :"
	@if [ -f "../env/.env.dev" ]; then \
		echo "   Teams App ID : $(shell grep TEAMS_APP_ID ../env/.env.dev | cut -d= -f2)"; \
		echo "   Bot ID       : $(shell grep BOT_ID ../env/.env.dev | cut -d= -f2)"; \
	else \
		echo "   âš ï¸  Fichier .env.dev manquant"; \
	fi
	@echo ""
	@echo "ðŸ”— Offre SaaS Ã  lier :"
	@echo "   Nom          : Teams GPT"
	@echo "   Ã‰diteur      : Cotechnoe Inc."
	@echo "   Plans        : dev-01, pay-as-you-go, Plan de test"
	@echo ""
	@echo "ðŸ“‹ Documentation :"
	@echo "   Guide        : $(shell pwd)/../doc/guides/partner-center-teams-configuration.md"
	@echo "   Plans SaaS   : $(shell pwd)/../doc/plans/PARTNER-CENTER-PLANS-CONFIG.md"
	@echo ""
	@echo "ðŸŒ URLs Ã  configurer dans Partner Center :"
	@if [ -f "../env/.env.dev" ]; then \
		echo "   Support      : https://sac-02-portal.azurewebsites.net/support"; \
		echo "   Aide         : https://sac-02-portal.azurewebsites.net/help"; \
		echo "   ConfidentialitÃ© : https://sac-02-portal.azurewebsites.net/privacy"; \
		echo "   Conditions   : https://sac-02-portal.azurewebsites.net/terms"; \
	fi
	@echo ""
	@echo "âš ï¸  Ã€ prÃ©parer (Todo 8) :"
	@echo "   - Screenshots (3-5 images, 1280x720 ou 1920x1080)"
	@echo "   - VidÃ©o de dÃ©monstration (2-3 minutes)"
	@echo ""

.PHONY: help
help: ## Afficher l'aide
	@echo ""
	@echo "ðŸ“¦ Microsoft 365 Agents Toolkit - Commandes de DÃ©ploiement"
	@echo "=========================================================="
	@echo ""
	@echo "ðŸ“– Documentation : ./README.md"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ðŸ’¡ Exemples d'utilisation :"
	@echo "   make check-prereqs          # Valider les prÃ©requis"
	@echo "   make provision-playground   # Provisionner l'environnement Playground"
	@echo "   make deploy-dev             # DÃ©ployer en environnement Dev (Azure)"
	@echo "   make info                   # Afficher le statut de tous les environnements"
	@echo "   make partner-center-info    # Informations pour configuration Partner Center"
	@echo "   make inspect-package ENV=dev # Inspecter le contenu du package Dev"
	@echo ""

##@ Nettoyage

clean: ## Nettoyer les artefacts gÃ©nÃ©rÃ©s
	@echo "$(YELLOW)Nettoyage des artefacts...$(NC)"
	@rm -rf ../appPackage/build
	@rm -rf ../.localConfigs*
	@echo "$(GREEN)âœ“ Nettoyage terminÃ©$(NC)"

##@ Provision (CrÃ©ation des packages)

provision-playground: ## Provision environnement playground (via Toolkit)
	@echo "$(BLUE)Provision de l'environnement playground...$(NC)"
	@cd .. && npx atk provision --env playground
	@echo "$(GREEN)âœ“ Package crÃ©Ã© : appPackage/build/appPackage.playground.zip$(NC)"

provision-local: ## Provision environnement local (via Toolkit)
	@echo "$(BLUE)Provision de l'environnement local...$(NC)"
	@cd .. && npx atk provision --env local
	@echo "$(GREEN)âœ“ Package crÃ©Ã© : appPackage/build/appPackage.local.zip$(NC)"

provision-dev: ## Provision environnement dev Azure (via Toolkit)
	@echo "$(BLUE)Provision de l'environnement dev...$(NC)"
	@cd .. && npx atk provision --env dev
	@echo "$(GREEN)âœ“ Package crÃ©Ã© : appPackage/build/appPackage.dev.zip$(NC)"

##@ Deploy (DÃ©ploiement du code)

deploy-playground: ## Deploy code vers environnement playground (via Toolkit)
	@echo "$(BLUE)DÃ©ploiement vers playground...$(NC)"
	@cd .. && npx atk deploy --env playground
	@echo "$(GREEN)âœ“ DÃ©ploiement playground terminÃ©$(NC)"

deploy-local: ## Deploy code vers environnement local (via Toolkit)
	@echo "$(BLUE)DÃ©ploiement vers local...$(NC)"
	@cd .. && npx atk deploy --env local
	@echo "$(GREEN)âœ“ DÃ©ploiement local terminÃ©$(NC)"

deploy-dev: ## Deploy code vers environnement dev Azure (via Toolkit)
	@echo "$(BLUE)DÃ©ploiement vers dev Azure...$(NC)"
	@cd .. && npx atk deploy --env dev
	@echo "$(GREEN)âœ“ DÃ©ploiement dev terminÃ©$(NC)"

##@ Lancement de l'application

start-playground: ## Lancer l'application en mode playground
	@echo "$(BLUE)Lancement de l'application en mode playground...$(NC)"
	@cd .. && npm run dev:teamsfx:testtool

start-local: ## Lancer l'application en mode local
	@echo "$(BLUE)Lancement de l'application en mode local...$(NC)"
	@cd .. && npm run dev:teamsfx

##@ Workflows complets

full-playground: clean provision-playground deploy-playground ## Workflow complet : Provision + Deploy playground
	@echo "$(GREEN)âœ“ Workflow playground terminÃ©$(NC)"
	@echo "$(YELLOW)Lancer l'app avec : make start-playground$(NC)"

full-local: clean provision-local deploy-local ## Workflow complet : Provision + Deploy local
	@echo "$(GREEN)âœ“ Workflow local terminÃ©$(NC)"
	@echo "$(YELLOW)Lancer l'app avec : make start-local$(NC)"

full-dev: clean provision-dev deploy-dev ## Workflow complet : Provision + Deploy dev
	@echo "$(GREEN)âœ“ Workflow dev Azure terminÃ©$(NC)"

##@ Validation

validate-manifest: ## Valider le manifest source
	@echo "$(BLUE)Validation du manifest source...$(NC)"
	@cat ../appPackage/manifest.json | jq '.' > /dev/null
	@echo "$(GREEN)âœ“ Manifest JSON valide$(NC)"

check-package: ## VÃ©rifier les packages gÃ©nÃ©rÃ©s
	@echo "$(BLUE)VÃ©rification des packages...$(NC)"
	@if [ -d "../appPackage/build" ]; then \
		ls -lh ../appPackage/build/*.zip 2>/dev/null || echo "$(YELLOW)âš  Aucun package trouvÃ© dans appPackage/build/$(NC)"; \
	else \
		echo "$(YELLOW)âš  Le rÃ©pertoire appPackage/build/ n'existe pas$(NC)"; \
		echo "$(YELLOW)  ExÃ©cuter: make provision-playground ou make provision-local$(NC)"; \
	fi

inspect-package: ## Inspecter le contenu d'un package (usage: make inspect-package ENV=playground)
	@if [ -z "$(ENV)" ]; then \
		echo "$(RED)Erreur: SpÃ©cifier ENV=playground|local|dev$(NC)"; \
		exit 1; \
	fi
	@if [ -f "../appPackage/build/appPackage.$(ENV).zip" ]; then \
		echo "$(BLUE)Contenu de appPackage.$(ENV).zip :$(NC)"; \
		unzip -l ../appPackage/build/appPackage.$(ENV).zip; \
	else \
		echo "$(RED)Package non trouvÃ© : appPackage/build/appPackage.$(ENV).zip$(NC)"; \
		echo "$(YELLOW)ExÃ©cuter: make provision-$(ENV)$(NC)"; \
	fi

##@ Informations

info: ## Afficher les informations sur les environnements
	@echo "$(BLUE)=== Informations sur les environnements ===$(NC)"
	@echo ""
	@echo "$(YELLOW)Playground :$(NC)"
	@echo "  - Config  : m365agents.playground.yml"
	@echo "  - Env     : env/.env.playground"
	@echo "  - Package : appPackage/build/appPackage.playground.zip"
	@if [ -f "../appPackage/build/appPackage.playground.zip" ]; then echo "  $(GREEN)âœ“ Package crÃ©Ã©$(NC)"; else echo "  $(RED)âœ— Package manquant$(NC)"; fi
	@echo ""
	@echo "$(YELLOW)Local :$(NC)"
	@echo "  - Config  : m365agents.local.yml"
	@echo "  - Env     : env/.env.local"
	@echo "  - Package : appPackage/build/appPackage.local.zip"
	@if [ -f "../appPackage/build/appPackage.local.zip" ]; then echo "  $(GREEN)âœ“ Package crÃ©Ã©$(NC)"; else echo "  $(RED)âœ— Package manquant$(NC)"; fi
	@echo ""
	@echo "$(YELLOW)Dev (Azure) :$(NC)"
	@echo "  - Config  : m365agents.yml"
	@echo "  - Env     : env/.env.dev"
	@echo "  - Package : appPackage/build/appPackage.dev.zip"
	@if [ -f "../appPackage/build/appPackage.dev.zip" ]; then \
		echo "  $(GREEN)âœ“ Package crÃ©Ã©$(NC)"; \
		if [ -f "../env/.env.dev" ]; then \
			TEAMS_APP_ID=$$(grep "^TEAMS_APP_ID=" ../env/.env.dev | cut -d'=' -f2); \
			BOT_ID=$$(grep "^BOT_ID=" ../env/.env.dev | cut -d'=' -f2); \
			RG=$$(grep "^AZURE_RESOURCE_GROUP_NAME=" ../env/.env.dev | cut -d'=' -f2); \
			echo "  - Teams App ID : $$TEAMS_APP_ID"; \
			echo "  - Bot ID       : $$BOT_ID"; \
			echo "  - Resource Group : $$RG"; \
		fi \
	else \
		echo "  $(RED)âœ— Package manquant$(NC)"; \
	fi
	@echo ""
	@echo "$(YELLOW)Distribution (Assistant-GPT-Teams) :$(NC)"
	@echo "  - Snapshot : appPackage/distribution-snapshot/"
	@echo "  - Cible    : /media/psf/Developpement/00-GIT/Assistant-GPT-Teams"
	@if [ -d "/media/psf/Developpement/00-GIT/Assistant-GPT-Teams" ]; then \
		echo "  $(GREEN)âœ“ Repository cible trouvÃ©$(NC)"; \
	else \
		echo "  $(RED)âœ— Repository cible introuvable$(NC)"; \
	fi
	@if [ -f "../appPackage/distribution-snapshot/INSTALLATION.md" ]; then \
		echo "  $(GREEN)âœ“ Snapshot prÃªt pour distribution$(NC)"; \
	else \
		echo "  $(YELLOW)âš  Snapshot incomplet$(NC)"; \
	fi
	@echo "  $(BLUE)ðŸ’¡ Commandes :$(NC)"
	@echo "     make update-distribution-snapshot  # Mettre Ã  jour le snapshot"
	@echo "     make sync-distribution            # Synchroniser vers GitHub"

logs: ## Afficher les logs du Toolkit
	@echo "$(BLUE)Derniers logs Microsoft 365 Agents Toolkit :$(NC)"
	@if [ -d "../.teamsfx/log" ]; then \
		ls -lt ../.teamsfx/log/ | head -5; \
	else \
		echo "$(YELLOW)Aucun log trouvÃ©$(NC)"; \
	fi

##@ TÃ¢ches VS Code (recommandÃ©)

vscode-provision-dev: ## Provisionner via VS Code (Command Palette > Teams: Provision)
	@echo "$(BLUE)Pour provisionner les ressources Azure :$(NC)"
	@echo "1. Ouvrir Command Palette (Ctrl+Shift+P / Cmd+Shift+P)"
	@echo "2. Taper 'Teams: Provision'"
	@echo "3. SÃ©lectionner l'environnement 'dev'"
	@echo ""
	@echo "$(YELLOW)Ou utiliser : make check-package pour vÃ©rifier si dÃ©jÃ  provisionnÃ©$(NC)"

vscode-deploy-dev: ## DÃ©ployer via VS Code (Command Palette > Teams: Deploy)
	@echo "$(BLUE)Pour dÃ©ployer l'application sur Azure :$(NC)"
	@echo "1. Ouvrir Command Palette (Ctrl+Shift+P / Cmd+Shift+P)"
	@echo "2. Taper 'Teams: Deploy'"
	@echo "3. SÃ©lectionner l'environnement 'dev'"
	@echo ""
	@echo "$(YELLOW)Les ressources doivent Ãªtre provisionnÃ©es au prÃ©alable$(NC)"

task-playground: ## Lancer la tÃ¢che VS Code pour playground
	@echo "$(BLUE)Lancer la tÃ¢che 'Start Agent in Microsoft 365 Agents Playground'$(NC)"
	@echo "$(YELLOW)Cette commande doit Ãªtre exÃ©cutÃ©e depuis VS Code :$(NC)"
	@echo "  Terminal > Run Task > Start Agent in Microsoft 365 Agents Playground"

task-local: ## Lancer la tÃ¢che VS Code pour local
	@echo "$(BLUE)Lancer la tÃ¢che 'Start Agent Locally'$(NC)"
	@echo "$(YELLOW)Cette commande doit Ãªtre exÃ©cutÃ©e depuis VS Code :$(NC)"
	@echo "  Terminal > Run Task > Start Agent Locally"

task-dev: ## Voir le statut du dÃ©ploiement Azure
	@echo "$(BLUE)Application dÃ©ployÃ©e sur Azure :$(NC)"
	@if [ -f "../env/.env.dev" ]; then \
		echo "$(GREEN)âœ“ Environnement dev provisionnÃ©$(NC)"; \
		grep "BOT_AZURE_APP_SERVICE_RESOURCE_ID" ../env/.env.dev | cut -d'=' -f2 || echo "Resource ID non trouvÃ©"; \
	else \
		echo "$(YELLOW)âš  Environnement dev non provisionnÃ©$(NC)"; \
	fi

##@ PrÃ©requis

check-prereqs: ## VÃ©rifier les prÃ©requis d'installation
	@echo "$(BLUE)VÃ©rification des prÃ©requis...$(NC)"
	@command -v node >/dev/null 2>&1 || { echo "$(RED)âœ— Node.js non installÃ©$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ Node.js : $$(node --version)$(NC)"
	@command -v npm >/dev/null 2>&1 || { echo "$(RED)âœ— npm non installÃ©$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ npm : $$(npm --version)$(NC)"
	@command -v jq >/dev/null 2>&1 || { echo "$(YELLOW)âš  jq non installÃ© (optionnel)$(NC)"; }
	@if command -v jq >/dev/null 2>&1; then echo "$(GREEN)âœ“ jq installÃ©$(NC)"; fi
	@if [ -f "../package.json" ]; then echo "$(GREEN)âœ“ package.json trouvÃ©$(NC)"; fi
	@if [ -f "../m365agents.yml" ]; then echo "$(GREEN)âœ“ m365agents.yml trouvÃ©$(NC)"; fi
	@echo "$(GREEN)âœ“ Tous les prÃ©requis sont satisfaits$(NC)"

##@ Distribution

sync-distribution: ## Synchroniser le rÃ©pertoire de distribution vers Assistant-GPT-Teams
	@echo "$(BLUE)Synchronisation vers Assistant-GPT-Teams...$(NC)"
	@if [ ! -d "/media/psf/Developpement/00-GIT/Assistant-GPT-Teams" ]; then \
		echo "$(RED)âœ— DÃ©pÃ´t Assistant-GPT-Teams introuvable$(NC)"; \
		echo "$(YELLOW)  Chemin attendu: /media/psf/Developpement/00-GIT/Assistant-GPT-Teams$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "../appPackage/build/appPackage.dev.zip" ]; then \
		echo "$(RED)âœ— Package Teams introuvable$(NC)"; \
		echo "$(YELLOW)  Chemin attendu: appPackage/build/appPackage.dev.zip$(NC)"; \
		echo "$(YELLOW)  ExÃ©cutez d'abord: make provision-dev$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)â†’ Copie du contenu du rÃ©pertoire distribution-snapshot...$(NC)"
	@rsync -av --exclude='appPackage.dev.zip' ../appPackage/distribution-snapshot/ /media/psf/Developpement/00-GIT/Assistant-GPT-Teams/
	@echo "$(YELLOW)â†’ Copie du package Teams (renommÃ© en appPackage.zip)...$(NC)"
	@cp -v ../appPackage/build/appPackage.dev.zip /media/psf/Developpement/00-GIT/Assistant-GPT-Teams/appPackage.zip
	@echo "$(GREEN)âœ“ Fichiers copiÃ©s$(NC)"
	@echo ""
	@echo "$(YELLOW)â†’ Commit et push vers GitHub...$(NC)"
	@cd /media/psf/Developpement/00-GIT/Assistant-GPT-Teams && \
		git add . && \
		git status --short && \
		git commit -m "chore: Sync distribution files from teams-gpt-saas-acc" && \
		git push origin main
	@echo "$(GREEN)âœ“ Synchronisation terminÃ©e$(NC)"
	@echo ""
	@echo "$(BLUE)ðŸ“¦ Distribution mise Ã  jour :$(NC)"
	@echo "   https://github.com/Cotechnoe/Assistant-GPT-Teams"

update-distribution-snapshot: ## Mettre Ã  jour le snapshot avec le package Teams actuel
	@echo "$(BLUE)Mise Ã  jour du snapshot de distribution...$(NC)"
	@if [ ! -f "../appPackage/build/appPackage.dev.zip" ]; then \
		echo "$(RED)âœ— Package appPackage.dev.zip manquant$(NC)"; \
		echo "$(YELLOW)  ExÃ©cuter d'abord: make provision-dev$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)â†’ Copie du package Teams...$(NC)"
	@cp -v ../appPackage/build/appPackage.dev.zip ../appPackage/distribution-snapshot/
	@echo "$(GREEN)âœ“ Snapshot mis Ã  jour$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ’¡ Prochaine Ã©tape: make sync-distribution$(NC)"

.DEFAULT_GOAL := help
